<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Performa LAB ‚Äî Briefing de Diagn√≥stico v2</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2a; --muted:#8ea0c1; --text:#eaf0ff;
      --accent:#FFB84D; --accent2:#1E3A8A; --danger:#ff6a8b; --ok:#34d399;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 10% 0%, rgba(255,184,77,.12), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(30,58,138,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1050px; margin:0 auto; padding:24px 16px 60px;}
    header{
      display:flex; flex-wrap:wrap; gap:14px; align-items:center; justify-content:space-between;
      margin:10px 0 18px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:50px; height:50px; border-radius:14px;
      background:url('https://cdn.abacus.ai/images/489d8ed5-8803-4d48-981f-2f5a6b8ef9d3.png') center/contain no-repeat;
      box-shadow: var(--shadow);
    }
    h1{font-size:20px; margin:0; color:var(--accent);}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 14px;
      border-radius: 14px;
      font-weight:600;
      cursor:pointer;
      backdrop-filter: blur(10px);
      font-size:13px;
      transition:.2s;
    }
    button.primary{
      background: linear-gradient(135deg, rgba(255,184,77,.25), rgba(30,58,138,.25));
      border-color: rgba(255,184,77,.45);
    }
    button.danger{ border-color: rgba(255,106,139,.45); }
    button:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.2); }
    button:active{ transform: translateY(1px); }

    .grid{display:grid; grid-template-columns: 1fr; gap:14px;}
    @media(min-width:900px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{
      background: rgba(18,26,42,.92);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      font-size:14px; margin:0 0 10px;
      letter-spacing:.3px; text-transform: uppercase;
      color: rgba(234,240,255,.92);
      display:flex; align-items:center; justify-content:space-between;
    }
    .hint{font-size:12px; color:var(--muted); font-weight:500; text-transform:none; letter-spacing:0;}
    label{display:block; font-size:13px; color: rgba(234,240,255,.88); margin:10px 0 6px; font-weight:600;}
    label.required::after{content:" *"; color:var(--danger);}
    input[type="text"], input[type="tel"], input[type="url"], input[type="number"], input[type="email"], textarea, select{
      width:100%;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      outline:none;
      font-size: 14px;
      transition:.2s;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow: 0 0 0 3px rgba(255,184,77,.1);
    }
    textarea{ min-height: 92px; resize: vertical; }
    .row{display:grid; grid-template-columns: 1fr; gap:10px;}
    @media(min-width:900px){ .row.two{ grid-template-columns: 1fr 1fr; } }

    .checks{display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px;}
    @media(min-width:520px){ .checks{ grid-template-columns: 1fr 1fr; } }
    .check{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      transition:.2s;
    }
    .check:hover{ background: rgba(255,255,255,.06); }
    .check input{ transform: scale(1.25); margin-top:2px; cursor:pointer; }
    .check small{ display:block; color: var(--muted); margin-top:2px; font-size:12px; }

    .footer{
      margin-top:14px;
      display:grid; grid-template-columns: 1fr; gap:14px;
    }
    @media(min-width:900px){ .footer{ grid-template-columns: 1.15fr .85fr; } }

    .result{
      border:1px dashed rgba(255,184,77,.35);
      background: rgba(255,184,77,.06);
      border-radius: var(--radius);
      padding: 14px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      padding:8px 10px; border-radius: 999px; font-size:12px; color: var(--muted);
      margin: 6px 6px 0 0;
    }
    .kpi{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .good{border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.08); color: rgba(234,240,255,.92);}
    .warn{border-color: rgba(255,200,87,.35); background: rgba(255,200,87,.08); color: rgba(234,240,255,.92);}
    .bad{border-color: rgba(255,106,139,.35); background: rgba(255,106,139,.08); color: rgba(234,240,255,.92);}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .tiny{font-size:12px; color:var(--muted);}
    .alert{
      background: rgba(255,106,139,.1);
      border:1px solid rgba(255,106,139,.3);
      padding:12px;
      border-radius:12px;
      margin-top:10px;
      font-size:13px;
      color:var(--danger);
    }
    
    /* Modal */
    .modal{
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(8px);
    }
    .modal.show{ display: flex; }
    .modal-content{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow);
      text-align: center;
    }
    .modal-content h3{
      font-size: 24px;
      margin: 0 0 12px;
      color: var(--accent);
    }
    .modal-content p{
      color: var(--muted);
      margin-bottom: 24px;
      font-size: 14px;
    }
    .modal-btn{
      display: block;
      width: 100%;
      background: var(--accent2);
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: .2s;
    }
    .modal-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30,58,138,.4);
    }
    .modal-btn.secondary{
      background: #7c3aed;
    }
    .modal-btn.tertiary{
      background: #6b7280;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Performa LAB ‚Äî Briefing de Diagn√≥stico v2</h1>
          <div class="sub">Uso interno ‚Ä¢ para alimentar a IA e recomendar o pacote ideal (Start/Core/Scale)</div>
        </div>
      </div>
      <div class="actions">
        <button class="primary" type="button" onclick="analisar()">üéØ Gerar Recomenda√ß√£o</button>
        <button type="button" onclick="exportar('json')">üì• JSON</button>
        <button type="button" onclick="exportar('csv')">üìä CSV</button>
        <button type="button" onclick="verHistorico()">üìã Hist√≥rico</button>
        <button class="danger" type="button" onclick="limpar()">üóëÔ∏è Limpar</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>1) Identidade do neg√≥cio <span class="hint">Base de contexto</span></h2>
        <div class="row two">
          <div>
            <label class="required">Nome do restaurante</label>
            <input id="nome" type="text" placeholder="Ex.: Sabor do Brasil" required />
          </div>
          <div>
            <label class="required">Cidade / Bairro</label>
            <input id="local" type="text" placeholder="Ex.: Viseu ‚Ä¢ Centro" required />
          </div>
        </div>
        <div class="row two">
          <div>
            <label>Tipo de cozinha</label>
            <select id="cozinha">
              <option value="">‚Äî selecionar ‚Äî</option>
              <option>Brasileira</option>
              <option>Portuguesa</option>
              <option>Italiana</option>
              <option>Asi√°tica</option>
              <option>Fusion</option>
              <option>Fast-casual</option>
              <option>Outra</option>
            </select>
          </div>
          <div>
            <label>Tempo de funcionamento</label>
            <select id="tempo">
              <option value="">‚Äî selecionar ‚Äî</option>
              <option value="lt6">Menos de 6 meses</option>
              <option value="6a24">6 meses a 2 anos</option>
              <option value="gt24">Mais de 2 anos</option>
            </select>
          </div>
        </div>
        <div class="row two">
          <div>
            <label>N√∫mero m√©dio de lugares</label>
            <select id="lugares">
              <option value="">‚Äî selecionar ‚Äî</option>
              <option value="ate30">At√© 30</option>
              <option value="30a60">30‚Äì60</option>
              <option value="60plus">60+</option>
            </select>
          </div>
          <div>
            <label>Ticket m√©dio estimado (‚Ç¨)</label>
            <select id="ticket">
              <option value="">‚Äî selecionar ‚Äî</option>
              <option value="ate15">At√© ‚Ç¨15</option>
              <option value="15a30">‚Ç¨15‚Äì30</option>
              <option value="30plus">‚Ç¨30+</option>
            </select>
          </div>
        </div>
        <div class="row two">
          <div>
            <label>Contacto principal</label>
            <input id="contacto" type="tel" placeholder="+351 ..." />
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="contato@restaurante.pt" />
          </div>
        </div>
      </section>

      <section class="card">
        <h2>2) Decis√£o & maturidade <span class="hint">Qualifica√ß√£o</span></h2>

        <label class="required">Quem est√° respondendo?</label>
        <select id="cargo" required>
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="dono">Dono / S√≥cio</option>
          <option value="gerente">Gerente</option>
          <option value="outro">Outro</option>
        </select>

        <label class="required">Voc√™ decide sobre marketing e investimentos digitais?</label>
        <select id="decide" required>
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>

        <label>J√° investiu em marketing digital antes?</label>
        <select id="investiu">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="nunca">Nunca</option>
          <option value="ruim">J√°, mas sem resultados claros</option>
          <option value="ok">Sim, com algum retorno</option>
        </select>

        <label>N√≠vel de urg√™ncia</label>
        <select id="urgencia">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="baixa">Explorando op√ß√µes</option>
          <option value="media">Preciso resolver em 1-2 meses</option>
          <option value="alta">Urgente (semanas)</option>
        </select>

        <label>Notas (contexto r√°pido)</label>
        <textarea id="notas" placeholder="Ex.: j√° trocaram de ag√™ncia, problemas com consist√™ncia, dono quer previsibilidade..."></textarea>
      </section>

      <section class="card">
        <h2>3) Presen√ßa digital atual <span class="hint">Marca & base</span></h2>

        <label>O restaurante possui (marque o que existe hoje):</label>
        <div class="checks">
          <div class="check"><input id="ig" type="checkbox"><div><b>Instagram ativo</b><small>Posts recentes, stories, coer√™ncia visual</small></div></div>
          <div class="check"><input id="gmaps" type="checkbox"><div><b>Google Maps otimizado</b><small>Fotos, reviews, hor√°rio correto</small></div></div>
          <div class="check"><input id="site" type="checkbox"><div><b>Website pr√≥prio</b><small>Dom√≠nio, menu, contacto, localiza√ß√£o</small></div></div>
          <div class="check"><input id="qr" type="checkbox"><div><b>Card√°pio digital com QR</b><small>Bonito, r√°pido, atualizado</small></div></div>
        </div>

        <div class="row two">
          <div>
            <label>Voc√™ sente que a presen√ßa digital representa a qualidade do restaurante?</label>
            <select id="presenca">
              <option value="">‚Äî selecionar ‚Äî</option>
              <option value="nao">N√£o representa</option>
              <option value="ok">Est√° ok</option>
              <option value="top">Est√° profissional</option>
            </select>
          </div>
          <div>
            <label>Quando algu√©m encontra o restaurante online, voc√™ sente:</label>
            <select id="orgulho">
              <option value="">‚Äî selecionar ‚Äî</option>
              <option value="vergonha">Vergonha</option>
              <option value="tanto_faz">Indiferen√ßa</option>
              <option value="orgulho">Orgulho</option>
            </select>
          </div>
        </div>

        <label>Links (opcional)</label>
        <div class="row two">
          <input id="link_ig" type="url" placeholder="Instagram URL" />
          <input id="link_gmaps" type="url" placeholder="Google Maps URL" />
        </div>
      </section>

      <section class="card">
        <h2>4) Vendas & plataformas <span class="hint">Margem & depend√™ncia</span></h2>

        <label>Modelo de vendas atual</label>
        <select id="modelo">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="salao">Apenas sal√£o</option>
          <option value="salao_take">Sal√£o + take-away</option>
          <option value="salao_del">Sal√£o + delivery</option>
        </select>

        <label>Usa Glovo / Uber Eats?</label>
        <select id="plataformas">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="nao">N√£o</option>
          <option value="ocasional">Sim, ocasionalmente</option>
          <option value="diario">Sim, diariamente</option>
        </select>

        <label>% estimado do faturamento vindo das plataformas</label>
        <select id="pct_plat">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="0a20">0‚Äì20%</option>
          <option value="20a40">20‚Äì40%</option>
          <option value="40plus">40%+</option>
        </select>

        <label>Reduzir depend√™ncia √© prioridade?</label>
        <select id="prioridade_indep">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="dor">Sim, √© uma dor clara</option>
          <option value="naosei">Sim, mas n√£o sei como</option>
          <option value="nao">N√£o √© prioridade</option>
        </select>

        <label>Concorr√™ncia local</label>
        <select id="concorrencia">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="baixa">Pouca concorr√™ncia</option>
          <option value="media">Concorr√™ncia moderada</option>
          <option value="alta">Muito competitivo</option>
        </select>
      </section>

      <section class="card">
        <h2>5) Objetivos reais <span class="hint">Dire√ß√£o</span></h2>

        <label class="required">Principal objetivo agora</label>
        <select id="objetivo" required>
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="atrair">Atrair mais clientes</option>
          <option value="vendermais">Vender mais aos mesmos clientes</option>
          <option value="organizar">Organizar o digital</option>
          <option value="reduzir_taxas">Reduzir taxas das plataformas</option>
          <option value="escalar">Escalar o neg√≥cio</option>
        </select>

        <label>Onde quer estar em 6 meses?</label>
        <div class="checks">
          <div class="check"><input id="meta_cheio" type="checkbox"><div><b>Mais cheio</b><small>Ocupa√ß√£o consistente</small></div></div>
          <div class="check"><input id="meta_lucro" type="checkbox"><div><b>Mais lucrativo</b><small>Melhor margem</small></div></div>
          <div class="check"><input id="meta_indep" type="checkbox"><div><b>Menos dependente de terceiros</b><small>Canal pr√≥prio</small></div></div>
          <div class="check"><input id="meta_unidade" type="checkbox"><div><b>Pronto para nova unidade</b><small>Processo escal√°vel</small></div></div>
        </div>

        <label>Se o digital funcionasse bem, o que mudaria no dia a dia?</label>
        <textarea id="mudaria" placeholder="Ex.: previsibilidade, menos stress com apps, mais reservas, ticket maior..."></textarea>
      </section>

      <section class="card">
        <h2>6) Investimento (sem falar "pre√ßo") <span class="hint">Encaixe de pacote</span></h2>

        <label>Investir no digital precisa:</label>
        <select id="perfil_inv">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="acessivel">Ser o mais acess√≠vel poss√≠vel</option>
          <option value="custo_beneficio">Ter bom custo-benef√≠cio</option>
          <option value="crescimento">Trazer crescimento real, mesmo com investimento maior</option>
        </select>

        <label>Voc√™ prefere:</label>
        <select id="preferencia">
          <option value="">‚Äî selecionar ‚Äî</option>
          <option value="pontual">Algo pontual para testar</option>
          <option value="mensal">Um parceiro mensal</option>
          <option value="estrutura">Uma estrutura completa de crescimento</option>
        </select>

        <label>O que mais frustra hoje no digital?</label>
        <textarea id="frustracao" placeholder="Ex.: posts n√£o trazem clientes, tudo depende de promo nas apps, falta de tempo, imagem amadora..."></textarea>
      </section>
    </div>

    <div class="footer">
      <section class="result card">
        <h2>Recomenda√ß√£o (gerada) <span class="hint">Use no fecho</span></h2>
        <div id="rec_pacote" style="font-size:20px; font-weight:800; margin-top:6px; color:var(--accent);">‚Äî</div>
        <div id="rec_score" style="font-size:12px; color:var(--muted); margin-top:4px;"></div>
        <div id="rec_diag" style="margin-top:10px; color:rgba(234,240,255,.92); line-height:1.5;">Preencha os campos obrigat√≥rios e clique em <b>Gerar Recomenda√ß√£o</b>.</div>

        <div class="kpi" id="kpis"></div>

        <div id="proximos_passos" style="display:none; margin-top:14px;">
          <label>Pr√≥ximos Passos Recomendados</label>
          <div id="passos_lista" style="margin-top:8px;"></div>
        </div>

        <label style="margin-top:14px;">Texto pronto para enviar ao cliente (WhatsApp)</label>
        <textarea id="texto_cliente" class="mono" readonly></textarea>
        <div class="actions" style="margin-top:10px;">
          <button type="button" onclick="copiar('texto_cliente')">üìã Copiar Texto</button>
          <button class="primary" type="button" onclick="mostrarProximaAcao()">üöÄ Pr√≥ximos Passos</button>
        </div>
        <div class="tiny" style="margin-top:8px;">
          Dica: copie e personalize 1‚Äì2 palavras para soar 100% humano.
        </div>
      </section>

      <section class="card">
        <h2>Export / IA <span class="hint">Copiar e colar</span></h2>
        <label>Prompt interno (cole as respostas exportadas abaixo)</label>
        <textarea id="prompt_interno" class="mono" readonly style="min-height:180px;"></textarea>
        <div class="actions" style="margin-top:10px;">
          <button type="button" onclick="copiar('prompt_interno')">üìã Copiar Prompt</button>
          <button type="button" onclick="salvarHistorico()">üíæ Salvar no Hist√≥rico</button>
        </div>
        <div class="tiny" style="margin-top:10px;">
          ‚úÖ Autosave local ativado. Voc√™ pode fechar e voltar depois.
        </div>
      </section>
    </div>
  </div>

  <!-- Modal Pr√≥xima A√ß√£o -->
  <div id="modalProximaAcao" class="modal">
    <div class="modal-content">
      <h3>‚úÖ Diagn√≥stico Salvo!</h3>
      <p>O que deseja fazer agora?</p>
      
      <a href="proposta-performa.html" class="modal-btn">
        üìÑ Gerar Proposta Comercial
      </a>
      
      <a href="crm-performa.html" class="modal-btn secondary">
        üë• Adicionar ao CRM
      </a>
      
      <a href="contrato-performa.html" class="modal-btn secondary">
        üìù Gerar Contrato
      </a>
      
      <button onclick="fecharModal()" class="modal-btn tertiary">
        üîÑ Novo Diagn√≥stico
      </button>
    </div>
  </div>

<script>
  const KEY = "performa_briefing_v2";
  const HISTORY_KEY = "performa_briefing_history";
  const CLIENTE_KEY = "cliente_atual_performa";

  const ids = [
    "nome","local","cozinha","tempo","lugares","ticket","contacto","email",
    "cargo","decide","investiu","urgencia","notas",
    "ig","gmaps","site","qr","presenca","orgulho","link_ig","link_gmaps",
    "modelo","plataformas","pct_plat","prioridade_indep","concorrencia",
    "objetivo","meta_cheio","meta_lucro","meta_indep","meta_unidade","mudaria",
    "perfil_inv","preferencia","frustracao"
  ];

  let pacoteRecomendado = "";

  function getState(){
    const s = {};
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(el.type === "checkbox") s[id] = el.checked;
      else s[id] = el.value || "";
    });
    s._timestamp = new Date().toISOString();
    return s;
  }

  function setState(s){
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el || s[id] === undefined) return;
      if(el.type === "checkbox") el.checked = !!s[id];
      else el.value = s[id];
    });
  }

  function save(){
    localStorage.setItem(KEY, JSON.stringify(getState()));
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{ setState(JSON.parse(raw)); }catch(e){}
  }

  function limpar(){
    if(!confirm("Limpar tudo?")) return;
    localStorage.removeItem(KEY);
    localStorage.removeItem(CLIENTE_KEY);
    location.reload();
  }

  function validarCamposObrigatorios(){
    const required = ["nome","local","cargo","decide","objetivo"];
    for(let id of required){
      const el = document.getElementById(id);
      if(!el.value.trim()){
        alert(`‚ö†Ô∏è Campo obrigat√≥rio n√£o preenchido: ${el.previousElementSibling.textContent}`);
        el.focus();
        return false;
      }
    }
    return true;
  }

  function pacoteLabel(p){
    if(p==="start") return "Performa Start";
    if(p==="core") return "Performa Core (√Çncora)";
    if(p==="scale") return "Performa Scale (Premium)";
    return "‚Äî";
  }

  function pacoteParaIntegracao(p){
    if(p==="start") return "start";
    if(p==="core") return "core";
    if(p==="scale") return "scale";
    return "";
  }

  // Scoring refinado com pesos
  function analisar(){
    if(!validarCamposObrigatorios()) return;

    const s = getState();

    let scoreStart = 0, scoreCore = 0, scoreScale = 0;

    // Decis√£o (peso alto)
    if(s.decide !== "sim") scoreStart += 3;
    if(s.decide === "sim") { scoreCore += 2; scoreScale += 2; }

    // Presen√ßa / marca (peso alto)
    if(s.presenca === "nao" || s.orgulho === "vergonha") scoreStart += 4;
    if(s.presenca === "ok") scoreCore += 2;
    if(s.presenca === "top" && s.orgulho === "orgulho") scoreScale += 2;

    const baseDigital = (s.ig?1:0)+(s.gmaps?1:0)+(s.site?1:0)+(s.qr?1:0);
    if(baseDigital <= 1) scoreStart += 3;
    if(baseDigital === 2 || baseDigital === 3) scoreCore += 2;
    if(baseDigital >= 3) scoreScale += 1;

    // Plataformas / independ√™ncia (peso muito alto)
    if(s.plataformas === "diario") { scoreCore += 3; scoreScale += 3; }
    if(s.pct_plat === "40plus") { scoreCore += 3; scoreScale += 4; }
    if(s.pct_plat === "20a40") { scoreCore += 2; scoreScale += 2; }
    if(s.prioridade_indep === "dor" || s.prioridade_indep === "naosei") { scoreCore += 3; scoreScale += 2; }

    // Objetivo (peso alto)
    if(s.objetivo === "organizar") scoreStart += 4;
    if(s.objetivo === "reduzir_taxas") { scoreCore += 3; scoreScale += 2; }
    if(s.objetivo === "escalar" || s.meta_unidade) scoreScale += 4;
    if(s.objetivo === "atrair") { scoreCore += 2; scoreScale += 2; }

    // Investimento / prefer√™ncia (peso m√©dio)
    if(s.perfil_inv === "acessivel" || s.preferencia === "pontual") scoreStart += 3;
    if(s.perfil_inv === "custo_beneficio" || s.preferencia === "mensal") scoreCore += 3;
    if(s.perfil_inv === "crescimento" || s.preferencia === "estrutura") scoreScale += 3;

    // Urg√™ncia (peso baixo)
    if(s.urgencia === "alta") { scoreCore += 1; scoreScale += 1; }

    // Ticket m√©dio (peso m√©dio)
    if(s.ticket === "30plus") scoreScale += 2;
    if(s.ticket === "15a30") scoreCore += 1;

    // Concorr√™ncia (peso baixo)
    if(s.concorrencia === "alta") scoreScale += 1;

    // Resultado
    const scores = {start:scoreStart, core:scoreCore, scale:scoreScale};
    let escolhido = "core"; // Default √¢ncora
    
    // L√≥gica de desempate: prioriza Core, depois Scale, depois Start
    if(scores.scale > scores.core && scores.scale > scores.start) escolhido = "scale";
    else if(scores.start > scores.core && scores.start > scores.scale) escolhido = "start";

    pacoteRecomendado = pacoteLabel(escolhido);
    const rec = pacoteRecomendado;
    document.getElementById("rec_pacote").textContent = rec;
    document.getElementById("rec_score").textContent = `Scores: Start=${scores.start} | Core=${scores.core} | Scale=${scores.scale}`;

    // KPIs/pills
    const kpis = [];
    if(s.pct_plat === "40plus") kpis.push({t:"‚ö†Ô∏è Depend√™ncia alta de plataformas (40%+)", cls:"bad"});
    else if(s.pct_plat === "20a40") kpis.push({t:"‚ö° Depend√™ncia m√©dia de plataformas (20‚Äì40%)", cls:"warn"});
    else if(s.pct_plat === "0a20") kpis.push({t:"‚úÖ Baixa depend√™ncia de plataformas (0‚Äì20%)", cls:"good"});

    if(s.presenca === "nao" || s.orgulho === "vergonha") kpis.push({t:"‚ö†Ô∏è Presen√ßa digital desalinhada", cls:"bad"});
    if(s.presenca === "top") kpis.push({t:"‚úÖ Presen√ßa digital profissional", cls:"good"});
    if(s.meta_indep) kpis.push({t:"üéØ Meta: canal pr√≥prio / independ√™ncia", cls:"good"});
    if(s.meta_unidade) kpis.push({t:"üöÄ Meta: escala / nova unidade", cls:"good"});
    if(s.urgencia === "alta") kpis.push({t:"‚è∞ Urg√™ncia alta", cls:"warn"});
    if(s.ticket === "30plus") kpis.push({t:"üí∞ Ticket m√©dio alto (‚Ç¨30+)", cls:"good"});

    const kpiDiv = document.getElementById("kpis");
    kpiDiv.innerHTML = "";
    kpis.forEach(k=>{
      const el = document.createElement("span");
      el.className = `pill ${k.cls}`;
      el.textContent = k.t;
      kpiDiv.appendChild(el);
    });

    // Diagn√≥stico curto
    const diag = [];
    if(s.presenca === "nao") diag.push("Hoje o digital n√£o representa a qualidade do restaurante, o que trava percep√ß√£o e convers√£o.");
    if(s.plataformas === "diario" || s.pct_plat === "40plus") diag.push("Existe depend√™ncia relevante de plataformas, com impacto direto em margem e controlo da base de clientes.");
    if(s.objetivo === "organizar") diag.push("O momento pede organiza√ß√£o estrat√©gica antes de acelerar investimento em performance.");
    if(s.objetivo === "escalar" || s.meta_unidade) diag.push("H√° inten√ß√£o clara de escala, o que pede sistema e otimiza√ß√£o cont√≠nua.");
    if(diag.length === 0) diag.push("O restaurante tem base para crescer com um sistema consistente de presen√ßa + vendas.");

    // Justificativa por pacote
    let just = "";
    if(escolhido==="start"){
      just = "<b>Recomenda√ß√£o:</b> Come√ßar pelo <b>Start</b> para organizar posicionamento, identidade e base digital com clareza ‚Äî e ent√£o migrar para recorr√™ncia com seguran√ßa.";
    } else if(escolhido==="core"){
      just = "<b>Recomenda√ß√£o:</b> <b>Core</b> como servi√ßo √¢ncora para implementar um Sistema Digital de Vendas (presen√ßa + canal pr√≥prio) e trazer previsibilidade mensal.";
    } else {
      just = "<b>Recomenda√ß√£o:</b> <b>Scale</b> para acelerar crescimento com campanhas e otimiza√ß√£o cont√≠nua, mantendo foco em margem, ticket e independ√™ncia de terceiros.";
    }

    document.getElementById("rec_diag").innerHTML =
      `<b>Diagn√≥stico:</b> ${diag.join(" ")}<br><br>${just}`;

    // Pr√≥ximos Passos
    const passos = [];
    if(escolhido === "start") passos.push("1. Enviar proposta Start com escopo de identidade + presen√ßa");
    if(escolhido === "core") passos.push("1. Enviar proposta Core com Sistema Digital de Vendas");
    if(escolhido === "scale") passos.push("1. Enviar proposta Scale com campanhas + otimiza√ß√£o");
    passos.push("2. Agendar call de alinhamento (15-20 min)");
    passos.push("3. Preparar briefing de execu√ß√£o ap√≥s assinatura");

    const passosDiv = document.getElementById("passos_lista");
    passosDiv.innerHTML = passos.map(p => `<div style="padding:6px 0; font-size:13px;">‚úì ${p}</div>`).join("");
    document.getElementById("proximos_passos").style.display = "block";

    // Texto WhatsApp pronto
    const nome = (s.nome||"o restaurante").trim();
    const texto =
`Ol√°! üëã

Pelo que voc√™ me passou, ${nome} tem potencial claro de crescer no digital ‚Äî mas hoje existe perda de margem/controlo (especialmente quando a venda depende de terceiros) e falta de um sistema previs√≠vel.

Minha recomenda√ß√£o √©: *${rec}*.

Motivo: montar/ajustar a base e implementar um Sistema Digital de Vendas (presen√ßa + canal pr√≥prio), para voc√™ reduzir depend√™ncia e ganhar previsibilidade.

Se fizer sentido, eu te envio a proposta simples com escopo e pr√≥ximos passos. üìÑ

Quando podemos alinhar? üìÖ`;
    document.getElementById("texto_cliente").value = texto;

    // Prompt interno
    const payload = JSON.stringify(s, null, 2);
    const prompt =
`Atue como um Estrategista Comercial da Performa LAB (restaura√ß√£o em Portugal).
Com base no briefing abaixo, entregue:
1) Diagn√≥stico (3‚Äì5 linhas)
2) Pacote indicado (Start/Core/Scale)
3) Justificativa focada em crescimento e vendas (n√£o t√©cnica)
4) Pr√≥ximo passo recomendado (1)
5) Frase de fecho (1 linha)

Briefing (JSON):
${payload}

Recomenda√ß√£o gerada: ${rec}
Scores: Start=${scores.start} | Core=${scores.core} | Scale=${scores.scale}`;
    document.getElementById("prompt_interno").value = prompt;

    // SALVAR DADOS PARA INTEGRA√á√ÉO
    salvarClienteParaFluxo(escolhido);

    save();
  }

  function salvarClienteParaFluxo(pacote){
    const s = getState();
    const clienteData = {
      nome: s.nome,
      email: s.email,
      responsavel: s.cargo === "dono" ? "Propriet√°rio" : (s.cargo === "gerente" ? "Gerente" : "Respons√°vel"),
      telefone: s.contacto,
      setor: s.cozinha || "Restaura√ß√£o",
      pacoteRecomendado: pacoteParaIntegracao(pacote),
      objetivo: s.objetivo,
      orcamento: s.perfil_inv,
      local: s.local,
      observacoes: s.notas || s.frustracao || "",
      timestamp: Date.now()
    };

    localStorage.setItem(CLIENTE_KEY, JSON.stringify(clienteData));
  }

  function mostrarProximaAcao(){
    if(!pacoteRecomendado){
      alert("‚ö†Ô∏è Gere a recomenda√ß√£o primeiro clicando em 'Gerar Recomenda√ß√£o'");
      return;
    }
    document.getElementById("modalProximaAcao").classList.add("show");
  }

  function fecharModal(){
    document.getElementById("modalProximaAcao").classList.remove("show");
    if(confirm("Deseja limpar o formul√°rio para um novo diagn√≥stico?")){
      limpar();
    }
  }

  function exportar(tipo){
    const s = getState();
    const ts = new Date().toISOString().slice(0,19).replaceAll(":","-");
    const nomeArquivo = (s.nome || "cliente").replaceAll(" ","_");
    
    if(tipo === "json"){
      const blob = new Blob([JSON.stringify(s, null, 2)], {type:"application/json"});
      download(blob, `performa-briefing-${nomeArquivo}-${ts}.json`);
      return;
    }
    if(tipo === "csv"){
      const rows = [];
      rows.push(["campo","valor"]);
      Object.keys(s).forEach(k=>{
        rows.push([k, String(s[k]).replaceAll('"','""')]);
      });
      const csv = rows.map(r=>r.map(v=>`"${v}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      download(blob, `performa-briefing-${nomeArquivo}-${ts}.csv`);
      return;
    }
  }

  function download(blob, filename){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  function copiar(id){
    const el = document.getElementById(id);
    el.focus();
    el.select();
    document.execCommand("copy");
    alert("‚úÖ Copiado!");
  }

  function salvarHistorico(){
    const s = getState();
    if(!s.nome){
      alert("‚ö†Ô∏è Preencha o nome do restaurante antes de salvar no hist√≥rico.");
      return;
    }
    
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    history.unshift(s);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 20)));
    alert("‚úÖ Salvo no hist√≥rico!");
  }

  function verHistorico(){
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    if(history.length === 0){
      alert("üìã Hist√≥rico vazio. Salve briefings para v√™-los aqui.");
      return;
    }
    
    let msg = "üìã HIST√ìRICO DE BRIEFINGS:\n\n";
    history.forEach((item, idx) => {
      const data = new Date(item._timestamp).toLocaleString('pt-PT');
      msg += `${idx+1}. ${item.nome || "Sem nome"} (${item.local || "‚Äî"}) - ${data}\n`;
    });
    msg += "\nüí° Para carregar um briefing, use o console do navegador:\nlocalStorage.setItem('performa_briefing_v2', localStorage.getItem('performa_briefing_history'))";
    alert(msg);
  }

  // Autosave em qualquer mudan√ßa
  document.addEventListener("input", save);
  document.addEventListener("change", save);
  load();
</script>
</body>
</html>